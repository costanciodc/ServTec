<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pagamento - Micro SaaS</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1724;
      --muted:#94a3b8;
      --accent:#06b6d4;
      --accent-2:#0891b2;
      --glass: rgba(255,255,255,0.04);
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background:linear-gradient(180deg,#07101a 0%, #0b1220 100%);
      color: #f5f5f5;
      margin: 0;
      padding: 40px 0;
      display: flex;
      justify-content: center;
    }
    .container {
      background:linear-gradient(180deg,var(--panel), rgba(14,20,28,0.9));
      padding: 30px;
      margin:0px auto;
      border-radius: 15px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      font-size: 13px;
    }
    h1 { font-size: 22px; margin-bottom: 20px; color:var(--accent) }
    input[type="file"], .btn {
      background:var(--accent);
      color:#022;
      border:0;
      padding:11px 14px;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
    }
    .message { margin-top: 15px; font-size: 14px; }
    .error { color: #ff5252; }
    .success { color: #4caf50; }
    .copy-box{display:flex;align-items:center;justify-content:space-between;background:var(--glass);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);font-weight:700}
    .copy-num{font-size:16px;letter-spacing:0.6px}
    .btn{background:var(--accent);color:#022; border:0;padding:11px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn:hover, .file:hover{ background:var(--accent-2); }
    .status{padding:12px;border-radius:10px;background:rgba(6,182,212,0.08);color:var(--accent);font-weight:700;margin-top:12px}
    .pill{background:rgba(255,255,255,0.02);padding:8px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.02);font-weight:600}
    .small{font-size:13px;color:var(--muted)}
    .card{background:linear-gradient(180deg,var(--panel), rgba(14,20,28,0.9)); border-radius:14px; padding:22px; box-shadow:0 10px 30px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.03)}
    .file{background:var(--accent);color:#022; border:0;padding:11px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .file:hover{background:var(--accent-2)}

    .mensagem-box { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px 30px; border-radius: 10px; font-size: 16px; font-weight: bold; display: none; z-index: 9999; text-align: center; max-width: 80%; }
    .mensagem-box.sucesso { background: #2ecc71; color: #fff; }
    .mensagem-box.erro { background: #e74c3c; color: #fff; }
    .mensagem-box.info { background: #3498db; color: #fff; }
    .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px); background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #fff; padding: 14px 24px; border-radius: 12px; font-weight: 600; box-shadow: 0 6px 20px rgba(0,0,0,0.4); opacity: 0; transition: opacity 0.3s ease, transform 0.3s ease; z-index: 1000; }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    @media (max-width: 480px) {
       .container { margin: 20px; padding: 20px; width: 300px; }
       .card { width: 250px; }
       h1 { font-size: 18px; }
       .copy-num { font-size: 14px; }
       .btn { font-size: 14px; padding: 9px 12px; }
       input[type="file"] { width: 230px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Pagamento via Multicaixa Expresse</h1>
    <p>Realize a transferência no Multicaixa Expresse para o número abaixo. Depois, envie o comprovativo em PDF para validação automática.</p>
    <div class="pill small">Valor: <strong id="amount">100,00 Kz</strong></div>
    <div class="copy-box">
      <div class="copy-num" id="expresse-number">943799795</div>
      <button class="btn" type="button" onclick="copyNumber()">Copiar</button>
    </div>

    <div class="card">
      <h2 style="margin:0 0 6px;font-size:18px;color:var(--accent)">Enviar comprovativo</h2>
      <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" id="comprovativo" name="file" accept="application/pdf" class="file" required>
        <input type="hidden" id="modeloHidden" name="modelo">
        <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
          <button id="submitBtn" class="btn" type="submit">Enviar Comprovativo</button>
          <div class="small">Formatos: PDF.</div>
        </div>
      </form>

      <div id="mensagemBox" class="mensagem-box"></div>
      <div id="statusBox" class="status">Aguardando envio do comprovativo.</div>
    </div>
  </div>

  
  <script>
    (function(){
      // Timers
      let mensagemTimer = null;

      // Pega parâmetros da URL
      const urlParams = new URLSearchParams(window.location.search);
      let modelo = urlParams.get("modelo"); // ex: carta1, contrato1, requerer1
      let servico = urlParams.get("servico"); // ex: carta, contrato, requerimento

      // Se serviço não informado, tenta inferir pelo modelo. Se nenhum dos dois, assume 'requerimento'
      if (!servico) {
        if (modelo && modelo.toLowerCase().startsWith("carta")) servico = "carta";
        else if (modelo && modelo.toLowerCase().startsWith("contrato")) servico = "contrato";
        else if (modelo && modelo.toLowerCase().startsWith("requerer")) servico = "requerimento";
        else servico = "requerimento"; // fallback seguro (não usa cv1)
      }

      // Se modelo não informado, cria um modelo padrão baseado no serviço
      if (!modelo) {
        if (servico === "carta") modelo = "carta1";
        else if (servico === "contrato") modelo = "contrato1";
        else modelo = "requerer1";
      }

      // Preenche hidden inputs
      const modeloHidden = document.getElementById("modeloHidden");
      const servicoHidden = document.getElementById("servicoHidden");
      if (modeloHidden) modeloHidden.value = modelo;
      if (servicoHidden) servicoHidden.value = servico;

      // UI helpers
      function showToast(msg) {
        const t = document.createElement("div");
        t.className = "toast";
        t.innerText = msg;
        document.body.appendChild(t);
        requestAnimationFrame(()=> t.classList.add("show"));
        setTimeout(()=> {
          t.classList.remove("show");
          setTimeout(()=> t.remove(), 250);
        }, 3000);
      }

      function mostrarMensagem(texto, tipo) {
        const box = document.getElementById("mensagemBox");
        if (!box) return;
        box.innerText = texto;
        box.className = "mensagem-box " + (tipo || "");
        box.style.display = "block";
        if (mensagemTimer) clearTimeout(mensagemTimer);
        mensagemTimer = setTimeout(()=> {
          box.style.display = "none";
          mensagemTimer = null;
        }, 3000);
      }

      function copyNumber() {
        const num = document.getElementById("expresse-number")?.innerText || "";
        if (!num) { showToast("Número não disponível"); return; }
        navigator.clipboard?.writeText(num).then(()=> showToast("Número copiado com sucesso!"))
          .catch(()=> showToast("Não foi possível copiar automaticamente."));
      }

      // Form submit
      const uploadForm = document.getElementById("uploadForm");
      if (!uploadForm) return console.error("Form upload não encontrado");

      uploadForm.addEventListener("submit", async function(e){
        e.preventDefault();

        const submitBtn = document.getElementById("submitBtn");
        const statusBox = document.getElementById("statusBox");
        const fileInput = document.getElementById("comprovativo");

        if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
          mostrarMensagem("⚠️ Selecione um arquivo PDF antes de enviar.", "erro");
          return;
        }

        const file = fileInput.files[0];

        // valida tipo/nome do arquivo (PDF)
        const isPdf = (file.type === "application/pdf") || /\.pdf$/i.test(file.name);
        if (!isPdf) {
          mostrarMensagem("⚠️ O arquivo selecionado não é um PDF.", "erro");
          return;
        }

        // Prepara dados
        const formData = new FormData();
        formData.append("file", file);
        formData.append("modelo", modelo);
        formData.append("servico", servico);

        // UI: desabilita botão
        submitBtn.disabled = true;
        submitBtn.textContent = "Enviando...";
        if (statusBox) statusBox.innerText = "Enviando comprovativo...";
        mostrarMensagem("⏳ Validando comprovativo, aguarde...", "info");

        try {
          const resposta = await fetch("/api/verificarComprovativotodos", {
            method: "POST",
            body: formData
          });

          // tenta obter JSON (mesmo em error)
          let dados = null;
          try {
            dados = await resposta.json();
          } catch (parseErr) {
            console.error("Falha ao parsear JSON:", parseErr);
            mostrarMensagem("⚠️ Resposta inválida do servidor.", "erro");
            submitBtn.disabled = false;
            submitBtn.textContent = "Enviar Comprovativo";
            if (statusBox) statusBox.innerText = "Aguardando envio do comprovativo.";
            return;
          }

          const sucesso = dados && (dados.sucesso === true || dados.sucesso === "true");
          const mensagem = (dados && (dados.mensagem || dados.erro)) || "Falha na validação.";

          if (sucesso) {
            mostrarMensagem("✅ Pagamento validado!", "sucesso");
            if (statusBox) statusBox.innerText = "Pagamento validado.";

            // bloqueia envio futuro do mesmo comprovativo no frontend (evita reenvio imediato)
            submitBtn.textContent = "Validado";
            submitBtn.disabled = true;
            fileInput.disabled = true;

            // redireciona após breve pausa — mantém exatamente o modelo que veio
            setTimeout(()=> {
              const token = (dados && dados.token) ? String(dados.token) : "";
              let destino = "";
              if (servico === "requerimento") destino = "editor-requerimento.html";
              else if (servico === "contrato") destino = "editor-contrato.html";
              else if (servico === "carta") destino = "editor-carta.html";
              else destino = "editor.html";

              // usa o modelo exato recebido (não forçar para 1)
              const modeloFinal = modelo || "";
              const url = `${destino}?modelo=${encodeURIComponent(modeloFinal)}&token=${encodeURIComponent(token)}`;
              window.location.href = url;
            }, 1000);

          } else {
            // inválido
            mostrarMensagem("❌ " + mensagem, "erro");
            if (statusBox) statusBox.innerText = "Comprovativo inválido.";
            submitBtn.disabled = false;
            submitBtn.textContent = "Enviar Comprovativo";
          }

        } catch (err) {
          console.error("Erro na requisição:", err);
          mostrarMensagem("⚠️ Erro ao enviar comprovativo. Tente novamente.", "erro");
          if (statusBox) statusBox.innerText = "Erro no envio.";
          submitBtn.disabled = false;
          submitBtn.textContent = "Enviar Comprovativo";
        }
      });

      // fim IIFE
    })();
  </script>
</body>
</html>

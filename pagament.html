<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pagamento - Micro SaaS</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1724;
      --muted:#94a3b8;
      --accent:#06b6d4;
      --accent-2:#0891b2;
      --glass: rgba(255,255,255,0.04);
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background:linear-gradient(180deg,#07101a 0%, #0b1220 100%);
      color: #f5f5f5;
      margin: 0;
      padding: 40px 0;
      display: flex;
      justify-content: center;
    }
    .container {
      background:linear-gradient(180deg,var(--panel), rgba(14,20,28,0.9));
      padding: 30px;
      margin:0px auto;
      border-radius: 15px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      font-size: 13px;
    }
    h1 { font-size: 22px; margin-bottom: 20px; color:var(--accent) }
    input[type="file"] {
      background:var(--accent);
      color:#022;
      border:0;
      padding:11px 14px;
      border-radius:10px;
      font-weight:700;
      cursor:pointer;
    }
    .copy-box{display:flex;align-items:center;justify-content:space-between;background:var(--glass);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);font-weight:700}
    .copy-num{font-size:16px;letter-spacing:0.6px}
    .btn{background:var(--accent);color:#022; border:0;padding:11px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .btn:hover{background:var(--accent-2)}
    .status{padding:12px;border-radius:10px;background:rgba(6,182,212,0.08);color:var(--accent);font-weight:700;margin-top:12px}
    .small{font-size:13px;color:var(--muted)}
    .card{background:linear-gradient(180deg,var(--panel), rgba(14,20,28,0.9)); border-radius:14px; padding:22px; box-shadow:0 10px 30px rgba(2,6,23,0.6); border:1px solid rgba(255,255,255,0.03)}
    .file{background:var(--accent);color:#022; border:0;padding:11px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .file:hover{background:var(--accent-2)}
    .mensagem-box { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px 30px; border-radius: 10px; font-size: 16px; font-weight: bold; display: none; z-index: 9999; text-align: center; max-width: 80%; }
    .mensagem-box.sucesso { background: #2ecc71; color: #fff; }
    .mensagem-box.erro { background: #e74c3c; color: #fff; }
    .mensagem-box.info { background: #3498db; color: #fff; }
    .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px); background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #fff; padding: 14px 24px; border-radius: 12px; font-weight: 600; box-shadow: 0 6px 20px rgba(0,0,0,0.4); opacity: 0; transition: opacity 0.3s ease, transform 0.3s ease; z-index: 1000; }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    @media (max-width: 480px) {
      .container { margin: 20px; padding: 20px; width: 300px; }
      .card { width: 250px; }
      h1 { font-size: 18px; }
      .copy-num { font-size: 14px; }
      .btn { font-size: 14px; padding: 9px 12px; }
      input[type="file"] { width: 230px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Pagamento via Multicaixa Expresse</h1>

    <p>Realize a transferência no Multicaixa Expresse para o número abaixo. Depois, envie o comprovativo em PDF para validação automática.</p>

    <div class="meta">
      <div class="pill small">Valor: <strong id="amount">400 AOA</strong></div>

      <div style="margin-top:14px" class="field">
        <div class="copy-box">
          <div class="copy-num" id="expresse-number">943799795</div>
          <button class="btn" type="button" onclick="copyNumber()">Copiar</button>
        </div>

        <div style="margin-top:18px" class="card">
          <h2 style="margin:0 0 6px;font-size:18px;color:var(--accent)">Enviar comprovativo</h2>
          <p class="small">Depois de finalizar a transferência no Multicaixa Expresse, faça o upload do comprovativo aqui.</p>

          <form id="uploadForm" enctype="multipart/form-data">
            <!-- campo de arquivo (name="file" porque o backend espera 'file') -->
            <input type="file" id="comprovativo" name="file" accept="application/pdf" class="file" required>
            <!-- campos ocultos para manter serviço/modelo -->
            <input type="hidden" id="servicoHidden" name="servico">
            <input type="hidden" id="modeloHidden" name="modelo">

            <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
              <button id="submitBtn" class="btn" type="submit">Enviar Comprovativo</button>
              <div class="small">Formatos: PDF.</div>
            </div>
          </form>

          <div id="mensagemBox" class="mensagem-box"></div>
          <div id="statusBox" class="status">Aguardando envio do comprovativo.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Mostra mensagem centralizada (reutiliza mensagemBox) com desaparecimento automático
function mostrarMensagem(texto, tipo) {
  const mensagemBox = document.getElementById("mensagemBox");
  if (!mensagemBox) {
    alert(texto);
    return;
  }
  mensagemBox.innerText = texto;
  mensagemBox.className = "mensagem-box";
  if (tipo === "sucesso") mensagemBox.classList.add("sucesso");
  if (tipo === "erro") mensagemBox.classList.add("erro");
  if (tipo === "info") mensagemBox.classList.add("info");
  mensagemBox.style.display = "block";

  // desaparece automaticamente após 3 segundos
  setTimeout(() => {
    mensagemBox.style.display = "none";
  }, 3000);
}

// Handler do envio do comprovativo
document.getElementById("uploadForm").addEventListener("submit", async function (e) {
  e.preventDefault();

  const submitBtn = document.getElementById("submitBtn");
  const fileInput = document.getElementById("comprovativo");
  if (!fileInput || fileInput.files.length === 0) {
    mostrarMensagem("⚠️ Selecione um arquivo PDF antes de enviar.", "erro");
    return;
  }

  const formData = new FormData();
  formData.append("file", fileInput.files[0]);
  formData.append("servico", document.getElementById("servicoHidden").value);
  formData.append("modelo", document.getElementById("modeloHidden").value);

  submitBtn.disabled = true;
  submitBtn.textContent = "Enviando...";
  document.getElementById("statusBox").innerText = "Enviando comprovativo...";

  mostrarMensagem("⏳ Validando comprovativo, aguarde...", "info");

  try {
    const resposta = await fetch("/api/verificarComprovativo", {
      method: "POST",
      body: formData,
    });

    let dados;
    try {
      dados = await resposta.json();
    } catch (err) {
      console.error("Resposta inválida do servidor:", err);
      mostrarMensagem("⚠️ Resposta inválida do servidor.", "erro");
      submitBtn.disabled = false;
      submitBtn.textContent = "Enviar Comprovativo";
      document.getElementById("statusBox").innerText = "Aguardando envio do comprovativo.";
      return;
    }

    const sucesso = dados.sucesso === true || dados.sucesso === "true";
    const mensagem = dados.mensagem || dados.erro || "Falha na validação.";

    if (sucesso) {
      mostrarMensagem("✅ Pagamento validado com sucesso!", "sucesso");
      document.getElementById("statusBox").innerText = "Pagamento validado.";

      // redireciona mantendo serviço e modelo
      setTimeout(() => {
        window.location.href = `editor.html?servico=${encodeURIComponent(servico)}&modelo=${encodeURIComponent(modelo)}`;
      }, 1400); // redireciona após 1.4s para dar tempo da mensagem aparecer
    } else {
      mostrarMensagem("❌ " + mensagem, "erro");
      document.getElementById("statusBox").innerText = "Comprovativo inválido.";
      submitBtn.disabled = false;
      submitBtn.textContent = "Enviar Comprovativo";
    }
  } catch (error) {
    console.error("Erro no envio do comprovativo:", error);
    mostrarMensagem("⚠️ Erro ao enviar comprovativo. Tente novamente.", "erro");
    document.getElementById("statusBox").innerText = "Erro no envio.";
    submitBtn.disabled = false;
    submitBtn.textContent = "Enviar Comprovativo";
  }
});

  </script>
</body>
</html>
